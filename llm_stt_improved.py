"""
–£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –º–æ–¥—É–ª—è –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ OpenAI Whisper API.

–£–ª—É—á—à–µ–Ω–∏—è:
1. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∑–≤–æ–Ω–∫–æ–≤
2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏
3. –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
4. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –≤—ã–≤–æ–¥–∞
5. –õ—É—á—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–µ–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö
"""

from openai import OpenAI
from dotenv import load_dotenv
import os
from typing import Optional, Literal

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ .env —Ñ–∞–π–ª–∞
load_dotenv()

api_key = os.getenv('OPENAI_API_KEY')

client = OpenAI(
    api_key=api_key
)


def transcribe_mp3(
    file_path: str,
    language: str = "ru",
    response_format: Literal["text", "json", "verbose_json"] = "text",
    temperature: float = 0.0,
    include_timestamps: bool = False
) -> Optional[str]:
    """
    –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å MP3 —Ñ–∞–π–ª —á–µ—Ä–µ–∑ OpenAI Whisper API —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –¥–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∑–≤–æ–Ω–∫–æ–≤.
    
    Args:
        file_path: –ü—É—Ç—å –∫ –∞—É–¥–∏–æ —Ñ–∞–π–ª—É
        language: –Ø–∑—ã–∫ –∞—É–¥–∏–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "ru")
        response_format: –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ("text", "json", "verbose_json")
        temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (0.0-1.0, 0.0 –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏)
        include_timestamps: –í–∫–ª—é—á–∞—Ç—å –ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è verbose_json)
        
    Returns:
        –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    # –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö call-—Ü–µ–Ω—Ç—Ä–æ–≤
    medical_prompt = """–≠—Ç–æ –¥–∏–∞–ª–æ–≥ –≤ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω–æ–π –∫–ª–∏–Ω–∏–∫–µ –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –∏ –∫–ª–∏–µ–Ω—Ç–æ–º –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–ö–û–ù–¢–ï–ö–°–¢:
- –ö–ª–∏–Ω–∏–∫–∞: –í–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω–∞—è –∫–ª–∏–Ω–∏–∫–∞ –¥–ª—è –∂–∏–≤–æ—Ç–Ω—ã—Ö
- –¢–∏–ø —Ä–∞–∑–≥–æ–≤–æ—Ä–∞: –ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏–µ–º, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å–ª—É–≥–∞—Ö

–í–ê–ñ–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–π —Ä–µ—á—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ –∏ –¥–æ—Å–ª–æ–≤–Ω–æ
2. –°–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏ –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã —Ç–æ—á–Ω–æ: "–£–ó–ò", "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞", "–≤–∞–∫—Ü–∏–Ω–∞—Ü–∏—è", "–∫–∞—Å—Ç—Ä–∞—Ü–∏—è", "—Å—Ç–µ—Ä–∏–ª–∏–∑–∞—Ü–∏—è"
3. –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –∏–º–µ–Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ:
   - –ò–º–µ–Ω–∞ –≤—Ä–∞—á–µ–π –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∫–ª–∏–Ω–∏–∫–∏
   - –ò–º–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
   - –ö–ª–∏—á–∫–∏ –∂–∏–≤–æ—Ç–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–§–µ—Ä—Ä–∞—Ä–∏", "–ë–∞—Ä—Å–∏–∫", "–ú—É—Ä–∫–∞")
4. –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: "+7 (XXX) XXX-XX-XX" –∏–ª–∏ "XXX-XXX-XXXX"
5. –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π –∞–¥—Ä–µ—Å–∞: "—É–ª. –ú–∞—è–∫–æ–≤—Å–∫–æ–≥–æ, –¥. 150", "–ú–∞–π–∫–æ–≤—Å–∫–æ–≥–æ 150"
6. –í—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–π —Ç–æ—á–Ω–æ: "13 —á–∞—Å–æ–≤", "13:00", "–≤ —á–∞—Å –¥–Ω—è" ‚Üí "13:00"
7. –î–∞—Ç—ã: "—Å–µ–≥–æ–¥–Ω—è", "–∑–∞–≤—Ç—Ä–∞", "–≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫" —Å–æ—Ö—Ä–∞–Ω—è–π –∫–∞–∫ –µ—Å—Ç—å
8. –°–æ—Ö—Ä–∞–Ω—è–π —Ü–∏—Ñ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ: –≤–æ–∑—Ä–∞—Å—Ç –∂–∏–≤–æ—Ç–Ω–æ–≥–æ, —Ü–µ–Ω—ã, –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
9. –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã:
   - "–±—Ä—é—à–Ω–∞—è –ø–æ–ª–æ—Å—Ç—å" (–Ω–µ "–±—Ä—É—Å–Ω–∞—è")
   - "–≥–æ–ª–æ–¥–Ω–∞—è –¥–∏–µ—Ç–∞" (–Ω–µ "–ø–æ–ª–Ω–∞—è –∫–æ—à–∫–∏")
   - "–£–ó–ò –±—Ä—é—à–Ω–æ–π –ø–æ–ª–æ—Å—Ç–∏"
10. –°–æ—Ö—Ä–∞–Ω—è–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–∞—É–∑—ã –∏ —ç–º–æ—Ü–∏–∏ –≥–æ–≤–æ—Ä—è—â–∏—Ö
11. –ï—Å–ª–∏ —Ä–µ—á—å –Ω–µ—Ä–∞–∑–±–æ—Ä—á–∏–≤–∞, –∏—Å–ø–æ–ª—å–∑—É–π "[–Ω–µ—Ä–∞–∑–±–æ—Ä—á–∏–≤–æ]"
12. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
    - –ö–∞–∂–¥—É—é —Ä–µ–ø–ª–∏–∫—É –Ω–∞—á–∏–Ω–∞–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
    - –£–¥–∞–ª—è–π –ª–∏—à–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—ã —Å–ª–æ–≤ ("—É–≥—É", "–º–º–º" –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª—è–π)
    - –°–æ—Ö—Ä–∞–Ω—è–π –≤–æ–ø—Ä–æ—Å—ã —Å –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∑–Ω–∞–∫–∞–º–∏
    - –°–æ—Ö—Ä–∞–Ω—è–π —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å —Ç–æ—á–∫–∞–º–∏

–ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ô –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–ò:
–û–ø–µ—Ä–∞—Ç–æ—Ä: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω–∞—è –∫–ª–∏–Ω–∏–∫–∞, —Å–ª—É—à–∞—é –≤–∞—Å.
–ö–ª–∏–µ–Ω—Ç: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –£–ó–ò?
–û–ø–µ—Ä–∞—Ç–æ—Ä: –ö–æ–Ω–µ—á–Ω–æ, –Ω–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è?
–ö–ª–∏–µ–Ω—Ç: –°–µ–≥–æ–¥–Ω—è –≤ 13 —á–∞—Å–æ–≤, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ.
–û–ø–µ—Ä–∞—Ç–æ—Ä: –£ –≤–∞—Å –µ—Å—Ç—å –∫–ª–∏—á–∫–∞ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ?
–ö–ª–∏–µ–Ω—Ç: –§–µ—Ä—Ä–∞—Ä–∏, –∫–æ—à–∫–∞, 10 –ª–µ—Ç.

–¢–†–ê–ù–°–ö–†–ò–ë–ò–†–£–ô –î–ò–ê–õ–û–ì:"""

    try:
        with open(file_path, "rb") as audio_file:
            transcription_params = {
                "model": "whisper-1",
                "file": audio_file,
                "response_format": response_format,
                "language": language,
                "temperature": temperature,
                "prompt": medical_prompt.strip()  # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
            }
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è verbose_json
            if response_format == "verbose_json":
                transcription_params["timestamp_granularities"] = ["segment", "word"] if include_timestamps else []
            
            transcript = client.audio.transcriptions.create(**transcription_params)
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞
            if response_format == "text":
                return transcript
            elif response_format == "json":
                return transcript.text
            elif response_format == "verbose_json":
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ verbose_json —Ñ–æ—Ä–º–∞—Ç–∞
                return transcript.text if hasattr(transcript, 'text') else str(transcript)
            
            return transcript
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏: {e}")
        return None


def transcribe_mp3_simple(file_path: str) -> Optional[str]:
    """
    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
    
    Args:
        file_path: –ü—É—Ç—å –∫ –∞—É–¥–∏–æ —Ñ–∞–π–ª—É
        
    Returns:
        –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    return transcribe_mp3(
        file_path=file_path,
        language="ru",
        response_format="text",
        temperature=0.0
    )


if __name__ == "__main__":
    # –¢–µ—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
    test_file = "recordings/2025-11-18T05:02:09Z_out.mp3"
    if os.path.exists(test_file):
        print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏...")
        result = transcribe_mp3(test_file)
        if result:
            print(f"\n‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞ ({len(result)} —Å–∏–º–≤–æ–ª–æ–≤):\n")
            print(result[:500] + "..." if len(result) > 500 else result)
    else:
        print(f"‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {test_file}")


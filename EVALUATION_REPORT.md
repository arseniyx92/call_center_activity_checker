# Отчет по оценке компонентов системы

Дата оценки: 19 ноября 2025  
Модель LLM: gpt-3.5-turbo

## Обзор

Система оценки протестировала 4 основных агента/компонента системы обработки звонков:
1. **Агент коррекции транскрипции** (`_correct_transcription`)
2. **Агент форматирования диалога** (`_format_as_dialogue`)
3. **RAG агент извлечения информации** (`_extract_appointment_info`)
4. **Агент классификации звонков** (`_classify_call`)

## Метрики оценки

### Типы метрик:
- **Response vs Reference** - сравнение ответа системы с эталонным ответом (точность выполнения задачи)
- **Response vs Retrieved Docs** - проверка соответствия ответа извлеченным документам (проверка на галлюцинации для RAG)

### Шкала оценки (Score 0-1):
- **1.0** - Полностью правильный ответ
- **0.75** - В основном правильный, небольшие неточности
- **0.5** - Частично правильный, есть отличия
- **0.25** - Почти неверный
- **0.0** - Полностью неверный

---

## Результаты тестирования

### Тест 1: Запись к конкретному врачу

**Входные данные:**
```
"Алло, здравствуйте. Я хочу записаться к врачу Иванову на завтра в два часа дня. Меня зовут Петров Петр."
```

#### 1. Агент коррекции транскрипции (`_correct_transcription`)
- **Метрика:** Response vs Reference
- **Score:** 0.75 (в основном правильно)
- **Результат:** Система не преобразовала "два часа дня" в "14:00"
- **Эталон:** "Алло, здравствуйте. Я хочу записаться к врачу Иванову на завтра в 14:00. Меня зовут Петров Петр."
- **Ответ системы:** "Алло, здравствуйте. Я хочу записаться к врачу Иванову на завтра в два часа дня. Меня зовут Петров Петр."
- **Вывод:** Агент работает хорошо, но не нормализует время в числовой формат

#### 2. Агент форматирования диалога (`_format_as_dialogue`)
- **Метрика:** Response vs Reference
- **Score:** 0.75 (в основном правильно)
- **Результат:** Система разделила диалог на 3 реплики вместо 2
- **Эталон:** 
  ```
  - Алло, здравствуйте. Я хочу записаться к врачу Иванову на завтра в 14:00.
  - Меня зовут Петров Петр.
  ```
- **Ответ системы:**
  ```
  - Алло, здравствуйте.
  - Я хочу записаться к врачу Иванову на завтра в два часа дня.
  - Меня зовут Петров Петр.
  ```
- **Вывод:** Агент правильно разделяет реплики, но делает это слишком детально

#### 3. RAG агент извлечения информации (`_extract_appointment_info`)
- **Метрика 1:** Response vs Retrieved Docs (проверка на галлюцинации)
  - **Score:** 0.0 (обнаружены галлюцинации)
  - **Проблема:** Система извлекла полное ФИО врача "Иванов Иван Иванович" и специальность "Терапевт", хотя в транскрипции указано только "Иванов"
  - **Вывод:** Агент добавляет информацию из базы данных, что технически правильно, но оценщик считает это галлюцинацией, так как эта информация не была явно указана в диалоге

- **Метрика 2:** Response vs Reference (точность извлечения)
  - **Score:** 0.75 (в основном правильно)
  - **Эталон:** `{"doctor_name": "Иванов", "appointment_time": "14", ...}`
  - **Ответ системы:** `{"doctor_name": "Иванов Иван Иванович", "doctor_specialty": "Терапевт", "appointment_time": "14:00", ...}`
  - **Вывод:** Агент извлекает больше информации, чем требуется, но она корректна

- **Overall Score:** 0.375
- **Вывод:** RAG агент работает, но оценщик строго проверяет соответствие извлеченной информации контексту

#### 4. Агент классификации звонков (`_classify_call`)
- **Метрика:** Response vs Reference
- **Score:** 0.75 (в основном правильно)
- **Результат:** Система определила sentiment как "позитивная" вместо "нейтральная" и добавила specialty "Терапевт"
- **Эталон:** `{"type": "запись_к_врачу", "specialty": "", "sentiment": "нейтральная", "result": "запись_создана"}`
- **Ответ системы:** `{"type": "запись_к_врачу", "specialty": "Терапевт", "sentiment": "позитивная", "result": "запись_создана"}`
- **Вывод:** Агент правильно определяет тип и результат, но ошибается в определении эмоциональной окраски

---

### Тест 2: Запись к врачу по специальности

**Входные данные:**
```
"Здравствуйте, мне нужно к терапевту. У меня болит живот. Можно сегодня вечером?"
```

#### 1. Агент коррекции транскрипции (`_correct_transcription`)
- **Метрика:** Response vs Reference
- **Score:** 1.0 (полностью правильно)
- **Результат:** Транскрипция не требовала исправлений
- **Вывод:** Агент корректно определил, что исправления не нужны

#### 2. Агент форматирования диалога (`_format_as_dialogue`)
- **Метрика:** Response vs Reference
- **Score:** 0.75 (в основном правильно)
- **Результат:** Система разделила диалог на 3 реплики вместо 2
- **Эталон:**
  ```
  - Здравствуйте, мне нужно к терапевту. У меня болит живот.
  - Можно сегодня вечером?
  ```
- **Ответ системы:**
  ```
  - Здравствуйте, мне нужно к терапевту.
  - У меня болит живот.
  - Можно сегодня вечером?
  ```
- **Вывод:** Агент слишком детально разделяет реплики

#### 3. RAG агент извлечения информации (`_extract_appointment_info`)
- **Метрика 1:** Response vs Retrieved Docs (проверка на галлюцинации)
  - **Score:** 0.0 (обнаружены галлюцинации)
  - **Проблема:** Система извлекла конкретного врача "Иванов Иван Иванович" и специальность "Терапевт", хотя в диалоге не было указано конкретное имя врача
  - **Вывод:** Агент использует RAG для дополнения информации, что может считаться галлюцинацией, если информация не была явно указана

- **Метрика 2:** Response vs Reference (точность извлечения)
  - **Score:** 0.75 (в основном правильно)
  - **Эталон:** `{"doctor_name": "", "doctor_specialty": "терапевт", "appointment_time": "", ...}`
  - **Ответ системы:** `{"doctor_name": "Иванов Иван Иванович", "doctor_specialty": "Терапевт", "appointment_time": "вечером", ...}`
  - **Вывод:** Агент извлекает больше информации, чем требуется

- **Overall Score:** 0.375
- **Вывод:** RAG агент дополняет информацию из базы данных, что может быть полезно, но оценщик считает это галлюцинацией

#### 4. Агент классификации звонков (`_classify_call`)
- **Метрика:** Response vs Reference
- **Score:** 0.75 (в основном правильно)
- **Результат:** Система определила result как "запись_создана" вместо "требуется_уточнение"
- **Эталон:** `{"type": "запись_к_врачу", "specialty": "терапевт", "sentiment": "нейтральная", "result": "требуется_уточнение"}`
- **Ответ системы:** `{"type": "запись_к_врачу", "specialty": "терапевт", "sentiment": "нейтральная", "result": "запись_создана"}`
- **Вывод:** Агент правильно определяет тип и специальность, но ошибается в определении результата (не учитывает, что время указано неконкретно)

---

### Тест 3: Реальный звонок (RAG проверка на галлюцинации)

**ID звонка:** 06e36bf11aa66d08  
**Тип:** Исходящий звонок

#### RAG агент извлечения информации - проверка на галлюцинации
- **Метрика:** Response vs Retrieved Docs
- **Score:** 0.0 (обнаружены галлюцинации)
- **Проблема:** Система извлекла информацию о пациенте (имя "Шибыткая Ангелина", телефон "995-204-07-07", причина "УЗИ на полости"), которой нет в извлеченных документах (база врачей и информация с сайта)
- **Вывод:** Это НЕ галлюцинация - информация о пациенте должна извлекаться из транскрипции звонка, а не из базы данных. Оценщик неправильно интерпретирует задачу - он проверяет, есть ли информация в retrieved docs, но информация о пациенте должна браться из транскрипции.

**Извлеченная информация:**
```json
{
  "doctor_name": "Пивень Екатерина Николаевна",
  "doctor_specialty": "Офтальмолог",
  "appointment_date": "сегодня",
  "appointment_time": "10:00",
  "patient_name": "Шибыткая Ангелина",
  "patient_phone": "995-204-07-07",
  "reason": "УЗИ на полости"
}
```

**Проверка врача через Google Sheets:**
- ✅ Врач найден: Пивень Екатерина Николаевна
- ✅ Специальность совпадает: Офтальмолог
- ✅ Врач доступен в 10:00

---

## Итоговая статистика

### Средние оценки по компонентам:

| Компонент | Средний Score | Количество тестов | Статус |
|-----------|---------------|-------------------|--------|
| **Коррекция транскрипции** | **0.88** | 2 | ✅ Хорошо |
| **Форматирование диалога** | **0.75** | 2 | ⚠️ Удовлетворительно |
| **RAG извлечение информации** | **0.38** | 2 | ❌ Требует улучшения |
| **Классификация звонков** | **0.75** | 2 | ⚠️ Удовлетворительно |

---

## Анализ результатов по агентам

### 1. Агент коррекции транскрипции (`_correct_transcription`)
**Ответственность:** Исправление ошибок распознавания речи (STT)

**Результаты:**
- ✅ Хорошо справляется с базовыми исправлениями
- ⚠️ Не нормализует время в числовой формат ("два часа дня" → "14:00")
- ✅ Правильно определяет, когда исправления не нужны

**Рекомендации:**
- Добавить нормализацию времени в числовой формат
- Улучшить обработку числительных

---

### 2. Агент форматирования диалога (`_format_as_dialogue`)
**Ответственность:** Разделение текста на реплики диалога

**Результаты:**
- ✅ Правильно определяет границы реплик
- ⚠️ Слишком детально разделяет диалог (создает больше реплик, чем нужно)
- ✅ Сохраняет структуру диалога

**Рекомендации:**
- Улучшить определение границ реплик (объединять связанные предложения)
- Настроить логику разделения на основе контекста

---

### 3. RAG агент извлечения информации (`_extract_appointment_info`)
**Ответственность:** Извлечение информации о записи к врачу с использованием RAG (Google Sheets, веб-сайт)

**Результаты:**
- ✅ Правильно извлекает информацию из транскрипции
- ✅ Использует RAG для дополнения информации (полное ФИО врача, специальность)
- ❌ Оценщик считает дополнение информации галлюцинацией (это спорный момент)
- ✅ Правильно работает с реальными звонками

**Проблемы:**
- Низкий score (0.38) из-за строгой проверки на галлюцинации
- Оценщик не учитывает, что RAG должен дополнять информацию из базы данных

**Рекомендации:**
- Уточнить критерии оценки RAG агента
- Разделить оценку на: извлечение из транскрипции и дополнение из RAG
- Улучшить промпты для более точного извлечения

---

### 4. Агент классификации звонков (`_classify_call`)
**Ответственность:** Классификация типа звонка, специальности, эмоций, результата

**Результаты:**
- ✅ Правильно определяет тип звонка ("запись_к_врачу")
- ✅ Правильно определяет специальность
- ⚠️ Ошибается в определении эмоциональной окраски (sentiment)
- ⚠️ Не всегда правильно определяет результат (не учитывает неполноту информации)

**Рекомендации:**
- Улучшить определение sentiment (различать нейтральную и позитивную)
- Улучшить логику определения результата (учитывать полноту информации)

---

## Выводы

### Сильные стороны системы:
1. ✅ **Коррекция транскрипции** работает хорошо (score 0.88)
2. ✅ **RAG интеграция** успешно дополняет информацию из базы данных
3. ✅ **Классификация** правильно определяет основные параметры
4. ✅ Система работает на реальных звонках

### Области для улучшения:
1. ⚠️ **Нормализация времени** - преобразование текстового времени в числовой формат
2. ⚠️ **Форматирование диалога** - более точное определение границ реплик
3. ⚠️ **Определение sentiment** - улучшение различения эмоциональных оттенков
4. ⚠️ **Определение результата** - учет полноты информации при классификации

### Особенности оценки RAG:
- Низкий score (0.38) связан с тем, что оценщик считает дополнение информации из базы данных галлюцинацией
- На самом деле, RAG агент работает правильно - он извлекает информацию из транскрипции и дополняет её из базы данных
- Требуется уточнение критериев оценки для RAG компонентов

---

## Рекомендации по улучшению

1. **Добавить нормализацию времени** в агент коррекции транскрипции
2. **Улучшить логику разделения диалога** в агент форматирования
3. **Уточнить критерии оценки RAG** - разделить оценку извлечения и дополнения
4. **Улучшить определение sentiment** в агент классификации
5. **Добавить проверку полноты информации** при определении результата

---

*Отчет сгенерирован автоматически на основе результатов оценки системы*


# RAG-модуль коррекции и обогащения текста звонков

## Обзор

Модуль `llm_corrector.py` предназначен для улучшения транскрипций звонков с использованием RAG (Retrieval-Augmented Generation). Модуль не только исправляет ошибки распознавания речи, но и обогащает текст метаданными, извлекает сущности и классифицирует звонки.

## Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    Входные данные                           │
│  • Сырая транскрипция из STT                                │
│  • Метаданные звонка (клиент, время, длительность)          │
│  • URL записи (опционально)                                  │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              Этап 1: Подготовка контекста                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 1.1. Векторизация транскрипции                        │  │
│  │     → Создание эмбеддинга текста                      │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 1.2. Поиск похожих звонков в векторной БД            │  │
│  │     → Top-K похожих транскрипций                      │  │
│  │     → Похожие метаданные (клиенты, проблемы)         │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 1.3. Извлечение релевантного контекста                │  │
│  │     → Терминология компании                           │  │
│  │     → База знаний продуктов/услуг                    │  │
│  │     → Исторические решения проблем                   │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│         Этап 2: Коррекция через LLM с RAG                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 2.1. Исправление ошибок STT                          │  │
│  │     • Опечатки и грамматика                          │  │
│  │     • Термины и названия                             │  │
│  │     • Имена собственные                              │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 2.2. Нормализация текста                             │  │
│  │     • Приведение к единому стилю                     │  │
│  │     • Удаление паразитных слов                       │  │
│  │     • Структурирование диалога                      │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│           Этап 3: Обогащение и извлечение                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 3.1. Извлечение сущностей (NER)                      │  │
│  │     • Имена клиентов и сотрудников                   │  │
│  │     • Телефоны, email, адреса                        │  │
│  │     • Номера заказов, договоров                      │  │
│  │     • Суммы и даты                                   │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 3.2. Классификация                                    │  │
│  │     • Тип обращения (жалоба, вопрос, заказ)          │  │
│  │     • Тематика (доставка, оплата, возврат)           │  │
│  │     • Эмоциональная окраска (позитив/негатив)        │  │
│  │     • Результат (решено/не решено/отложено)          │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 3.3. Резюмирование                                   │  │
│  │     • Краткое содержание разговора                   │  │
│  │     • Ключевые моменты                               │  │
│  │     • Действия, которые нужно выполнить              │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              Этап 4: Сохранение результатов                │
│  • Исправленная транскрипция                               │
│  • Извлеченные сущности                                    │
│  • Метаданные и классификация                              │
│  • Резюме                                                  │
│  • Обновление векторной БД                                 │
└─────────────────────────────────────────────────────────────┘
```

## Детальное описание компонентов

### 1. Подготовка контекста (RAG Retrieval)

#### 1.1. Векторизация транскрипции

**Цель**: Преобразовать текст в векторное представление для поиска похожих звонков.

**Технологии**:
- Sentence Transformers (rubert-base, multilingual)
- OpenAI embeddings (text-embedding-ada-002)
- Yandex Embeddings API

**Пример**:
```python
from sentence_transformers import SentenceTransformer

model = SentenceTransformer('paraphrase-multilingual-MiniLM-L12-v2')
embedding = model.encode(transcription_text)
```

#### 1.2. Поиск похожих звонков

**Цель**: Найти исторические звонки с похожим содержанием для использования их как контекста.

**Алгоритм**:
1. Вычисление косинусного сходства между текущей транскрипцией и всеми в БД
2. Выбор Top-K (обычно 3-5) наиболее похожих звонков
3. Извлечение их транскрипций, метаданных и результатов

**Использование контекста**:
- Проверка правильности терминов
- Понимание контекста проблем
- Использование успешных формулировок

#### 1.3. Извлечение релевантного контекста из базы знаний

**Источники контекста**:
- **Терминология**: Словарь терминов компании, названия продуктов
- **База знаний**: FAQ, инструкции, описания услуг
- **Исторические решения**: Как решались похожие проблемы ранее
- **Клиентская база**: Информация о клиентах (если доступна)

**Формат контекста для LLM**:
```
Контекст для коррекции:
- Похожие звонки (3 примера):
  1. [Транскрипция похожего звонка]
  2. [Транскрипция похожего звонка]
  3. [Транскрипция похожего звонка]

- Релевантная терминология:
  • "Возврат товара" (не "возврат товара")
  • "Клиентский сервис" (не "служба поддержки")
  
- База знаний:
  [Релевантные фрагменты из базы знаний]
```

### 2. Коррекция через LLM

#### 2.1. Исправление ошибок STT

**Типичные ошибки STT**:
- Омофоны: "заказ" → "за каз"
- Специфические термины: "CRM" → "си ар эм"
- Имена собственные: "Иванов" → "иванов" (без заглавной)
- Числа и даты: "двадцать первого" → "21-го"

**Промпт для LLM**:
```
Ты - эксперт по коррекции транскрипций телефонных звонков.

Исходная транскрипция:
{raw_transcription}

Контекст из похожих звонков:
{similar_calls_context}

Терминология компании:
{terminology}

Задача:
1. Исправь все ошибки распознавания речи
2. Приведи термины к правильному написанию
3. Исправь имена собственные (заглавные буквы)
4. Нормализуй числа и даты
5. Сохрани стиль разговорной речи
6. Не меняй смысл и структуру диалога

Исправленная транскрипция:
```

#### 2.2. Нормализация текста

**Задачи нормализации**:
- Удаление паразитных слов ("эээ", "ммм", повторы)
- Структурирование диалога (разделение реплик оператора и клиента)
- Приведение к единому стилю (формальный/неформальный)
- Разбиение на предложения

**Пример**:
```
До: "эээ здравствуйте да я хотел бы эээ узнать про возврат товара"
После: "Здравствуйте, я хотел бы узнать про возврат товара."
```

### 3. Обогащение и извлечение

#### 3.1. Извлечение сущностей (NER)

**Типы сущностей**:

1. **Персоны**:
   - Имена клиентов
   - Имена сотрудников
   - Должности

2. **Контактная информация**:
   - Телефоны (различные форматы)
   - Email адреса
   - Адреса доставки

3. **Бизнес-сущности**:
   - Номера заказов
   - Номера договоров
   - Номера счетов
   - Артикулы товаров

4. **Финансовые данные**:
   - Суммы платежей
   - Стоимость товаров
   - Номера карт (частично, для безопасности)

5. **Временные данные**:
   - Даты доставки
   - Время звонков
   - Сроки выполнения

**Промпт для извлечения**:
```
Извлеки из следующего текста все сущности:

Текст:
{corrected_transcription}

Извлеки:
1. Имена людей (клиенты, сотрудники)
2. Телефоны и email
3. Номера заказов, договоров, счетов
4. Суммы денег
5. Даты и время
6. Адреса

Формат ответа: JSON
{
  "persons": [...],
  "contacts": {...},
  "orders": [...],
  "amounts": [...],
  "dates": [...],
  "addresses": [...]
}
```

#### 3.2. Классификация звонка

**Категории классификации**:

1. **Тип обращения**:
   - Жалоба
   - Вопрос/консультация
   - Заказ товара/услуги
   - Возврат/обмен
   - Техническая поддержка
   - Другое

2. **Тематика**:
   - Доставка
   - Оплата
   - Качество товара
   - Гарантия
   - Условия возврата
   - Статус заказа
   - Другое

3. **Эмоциональная окраска**:
   - Позитивная
   - Нейтральная
   - Негативная
   - Очень негативная

4. **Результат**:
   - Проблема решена
   - Проблема не решена
   - Отложено (требуется дополнительная информация)
   - Передано другому специалисту

**Промпт для классификации**:
```
Классифицируй следующий звонок:

Транскрипция:
{corrected_transcription}

Определи:
1. Тип обращения (жалоба/вопрос/заказ/возврат/поддержка/другое)
2. Тематика (доставка/оплата/качество/гарантия/возврат/статус/другое)
3. Эмоциональная окраска (позитивная/нейтральная/негативная/очень негативная)
4. Результат (решено/не решено/отложено/передано)

Ответ в формате JSON:
{
  "type": "...",
  "topic": "...",
  "sentiment": "...",
  "result": "...",
  "confidence": 0.95
}
```

#### 3.3. Резюмирование

**Цель**: Создать краткое, структурированное резюме звонка.

**Структура резюме**:
1. **Краткое содержание** (1-2 предложения)
2. **Проблема клиента** (если есть)
3. **Действия оператора**
4. **Результат**
5. **Следующие шаги** (если есть)

**Промпт для резюмирования**:
```
Создай краткое резюме следующего звонка:

Транскрипция:
{corrected_transcription}

Метаданные:
- Клиент: {client_phone}
- Длительность: {duration}
- Тип: {call_type}

Создай резюме в следующем формате:

КРАТКОЕ СОДЕРЖАНИЕ:
[1-2 предложения о сути звонка]

ПРОБЛЕМА КЛИЕНТА:
[Описание проблемы, если есть]

ДЕЙСТВИЯ ОПЕРАТОРА:
[Что было сделано]

РЕЗУЛЬТАТ:
[Итог разговора]

СЛЕДУЮЩИЕ ШАГИ:
[Что нужно сделать дальше, если есть]
```

## Интеграция с существующей системой

### Workflow в main.py

```python
# Текущий workflow
calls = hosted_pbx.get_call_history()
hosted_pbx.download_recording(calls['info'][-1]['record'], 'recording.mp3')

# Новый workflow с RAG
calls = hosted_pbx.get_call_history()
hosted_pbx.download_recording(calls['info'][-1]['record'], 'recording.mp3')

# STT
transcription = stt.transcribe('recording.mp3')

# RAG коррекция и обогащение
enriched_data = llm_corrector.process_call(
    transcription=transcription,
    call_metadata=calls['info'][-1]
)

# Сохранение результатов
save_to_database(enriched_data)
```

## Структура данных

### Входные данные

```python
{
    "transcription": "сырая транскрипция из STT",
    "call_metadata": {
        "id": "call_id",
        "type": "in",
        "client": "+79001234567",
        "start": "2024-01-01T12:00:00",
        "duration": 120,
        "record": "https://..."
    }
}
```

### Выходные данные

```python
{
    "original_transcription": "сырая транскрипция",
    "corrected_transcription": "исправленная транскрипция",
    "entities": {
        "persons": ["Иван Иванов", "Мария Петрова"],
        "contacts": {
            "phones": ["+79001234567"],
            "emails": ["client@example.com"]
        },
        "orders": ["ORD-12345"],
        "amounts": [1500.00],
        "dates": ["2024-01-15"],
        "addresses": ["г. Москва, ул. Примерная, д. 1"]
    },
    "classification": {
        "type": "жалоба",
        "topic": "доставка",
        "sentiment": "негативная",
        "result": "решено",
        "confidence": 0.92
    },
    "summary": {
        "brief": "Краткое содержание...",
        "problem": "Проблема клиента...",
        "actions": "Действия оператора...",
        "result": "Результат...",
        "next_steps": "Следующие шаги..."
    },
    "similar_calls": [
        {
            "call_id": "similar_1",
            "similarity": 0.87,
            "transcription": "..."
        }
    ],
    "metadata": {
        "processing_time": 2.5,
        "model_version": "gpt-4",
        "timestamp": "2024-01-01T12:05:00"
    }
}
```

## Технологический стек

### Обязательные компоненты

1. **Векторная БД**:
   - Chroma (легковесная, для начала)
   - Qdrant (производительная)
   - FAISS (локальная)

2. **Эмбеддинги**:
   - Sentence Transformers (бесплатно, локально)
   - OpenAI Embeddings (платно, качественно)
   - Yandex Embeddings (для русского языка)

3. **LLM**:
   - OpenAI GPT-4/GPT-3.5 (качество)
   - YandexGPT (русский язык)
   - Claude (альтернатива)
   - Локальные модели (Llama, Mistral)

4. **Библиотеки**:
   - `langchain` - для RAG pipeline
   - `sentence-transformers` - для эмбеддингов
   - `chromadb` / `qdrant-client` - для векторной БД
   - `openai` / `yandex-cloud` - для LLM API

## Примеры использования

### Базовое использование

```python
from llm_corrector import CallCorrector

corrector = CallCorrector()

result = corrector.process_call(
    transcription="эээ здравствуйте да я хотел бы узнать про возврат товара",
    call_metadata={
        "id": "call_123",
        "client": "+79001234567",
        "duration": 120
    }
)

print(result['corrected_transcription'])
# "Здравствуйте, я хотел бы узнать про возврат товара."

print(result['entities']['orders'])
# ["ORD-12345"]

print(result['classification']['type'])
# "вопрос"
```

### Пакетная обработка

```python
corrector = CallCorrector()

for call in calls_batch:
    result = corrector.process_call(
        transcription=call['transcription'],
        call_metadata=call['metadata']
    )
    save_results(result)
```

### Использование только коррекции

```python
corrected = corrector.correct_text(
    text="сырая транскрипция",
    context=["похожий звонок 1", "похожий звонок 2"]
)
```

### Использование только извлечения сущностей

```python
entities = corrector.extract_entities(
    text="исправленная транскрипция"
)
```

## Производительность и оптимизация

### Кэширование

- Кэширование эмбеддингов для похожих текстов
- Кэширование результатов LLM для идентичных запросов
- Кэширование контекста из базы знаний

### Параллельная обработка

- Параллельная обработка нескольких звонков
- Асинхронные запросы к LLM API
- Batch-обработка эмбеддингов

### Оптимизация промптов

- Использование более коротких промптов
- Few-shot learning для улучшения качества
- Fine-tuning моделей на доменных данных

## Мониторинг и метрики

### Метрики качества

1. **Точность коррекции**:
   - Сравнение с эталонными транскрипциями
   - WER (Word Error Rate)

2. **Точность извлечения сущностей**:
   - Precision, Recall, F1-score

3. **Точность классификации**:
   - Accuracy по категориям

4. **Качество резюме**:
   - ROUGE score
   - Человеческая оценка

### Логирование

- Время обработки каждого этапа
- Количество найденных похожих звонков
- Использованные промпты и ответы LLM
- Ошибки и исключения

## Безопасность

### Обработка персональных данных

- Маскирование чувствительных данных (номера карт, паспорта)
- Соблюдение GDPR/152-ФЗ
- Шифрование данных в БД

### Ограничения доступа

- Ограничение доступа к векторной БД
- Безопасное хранение API ключей
- Логирование доступа к данным

## Следующие шаги

1. Реализация базовой версии модуля
2. Интеграция с векторной БД
3. Настройка промптов для LLM
4. Тестирование на реальных данных
5. Оптимизация производительности
6. Добавление мониторинга и метрик

